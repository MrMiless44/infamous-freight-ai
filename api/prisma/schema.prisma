generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  role      String   @default("user")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  onboarding UserOnboarding?
  referralCode ReferralCode?
  payments  Payment[]
  subscription Subscription?
  invoices  Invoice[]
}

model Driver {
  id          String   @id @default(cuid())
  name        String
  phone       String?
  status      String   @default("inactive")
  avatarCode  String?  // links to AI avatar theme
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  shipments   Shipment[] @relation(name: "ShipmentDriver")
}

model Shipment {
  id          String   @id @default(cuid())
  reference   String   @unique
  origin      String
  destination String
  status      String   @default("created")
  driverId    String?
  driver      Driver?  @relation(name: "ShipmentDriver", fields: [driverId], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model AiEvent {
  id        String   @id @default(cuid())
  type      String
  payload   Json
  createdAt DateTime @default(now())
}

model UserOnboarding {
  id             String   @id @default(cuid())
  userId         String   @unique
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  completedSteps String[] @default([])
  startedAt      DateTime @default(now())
  completedAt    DateTime?
}

model ReferralCode {
  id          String   @id @default(cuid())
  code        String   @unique
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  conversions Int      @default(0)
  createdAt   DateTime @default(now())
  rewards     ReferralReward[]
  conversions_detail ReferralConversion[]
}

model ReferralConversion {
  id              String   @id @default(cuid())
  referralCodeId  String
  referralCode    ReferralCode @relation(fields: [referralCodeId], references: [id], onDelete: Cascade)
  referredUserId  String
  convertedAt     DateTime @default(now())
  reward          String   @default("pending")
}

model ReferralReward {
  id             String   @id @default(cuid())
  referralCodeId String
  referralCode   ReferralCode @relation(fields: [referralCodeId], references: [id], onDelete: Cascade)
  amount         Float
  claimedAt      DateTime @default(now())
  status         String   @default("claimed")
}

model Payment {
  id                    String   @id @default(cuid())
  userId                String?
  user                  User?    @relation(fields: [userId], references: [id])
  stripePaymentIntentId String   @unique
  amount                Int
  currency              String   @default("usd")
  status                String
  metadata              Json?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([userId])
  @@index([status])
}

model Subscription {
  id                   String    @id @default(cuid())
  userId               String?   @unique
  user                 User?     @relation(fields: [userId], references: [id])
  stripeSubscriptionId String    @unique
  stripeCustomerId     String
  status               String
  priceId              String?
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean   @default(false)
  canceledAt           DateTime?
  metadata             Json?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  invoices             Invoice[]

  @@index([status])
  @@index([stripeCustomerId])
}

model Invoice {
  id               String       @id @default(cuid())
  userId           String?
  user             User?        @relation(fields: [userId], references: [id])
  subscriptionId   String?
  subscription     Subscription? @relation(fields: [subscriptionId], references: [id])
  stripeInvoiceId  String       @unique
  amountDue        Int
  amountPaid       Int
  currency         String       @default("usd")
  status           String
  attemptCount     Int          @default(0)
  metadata         Json?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  @@index([userId])
  @@index([subscriptionId])
}